# ç­–ç•¥ç³»ç»Ÿä½¿ç”¨æŒ‡å— (v2)

## ğŸ“ ç­–ç•¥æ–‡ä»¶å¤¹ç»“æ„

```
src/strategies/
â”œâ”€â”€ __init__.py                 # ç­–ç•¥æ¨¡å—å…¥å£/æ³¨å†Œ
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ strategy.py             # Strategy/StrategyConfig/strategy_registry
â”œâ”€â”€ etf_momentum_us/
â”‚   â””â”€â”€ strategy.py             # ç¾è‚¡ ETF åŠ¨é‡è½®åŠ¨ç­–ç•¥
â””â”€â”€ vwap/
    â””â”€â”€ vwap_pullback_v2.py     # VWAP å›è¸©ç­–ç•¥ (v2)
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1) ä½¿ç”¨ç°æœ‰ç­–ç•¥è¿›è¡Œå›æµ‹

```python
import asyncio
from datetime import date

from src.core.calendar import TradingCalendar
from src.core.context import RunContext, Environment
from src.evaluation.backtesting.engine import BacktestEngine
from src.strategies.vwap.vwap_pullback_v2 import VWAPPullbackStrategyV2, VWAPPullbackParams


async def main():
    strategy = VWAPPullbackStrategyV2(VWAPPullbackParams())
    engine = BacktestEngine(initial_capital=100000.0, commission_rate=0.0005, slippage_rate=0.0002)

    ctx = RunContext(
        env=Environment.BACKTEST,
        run_id="manual_run",
        trading_calendar=TradingCalendar(),
    )

    result = await engine.run(
        strategies=[strategy],
        universe=["SPY"],
        start=date(2024, 1, 1),
        end=date(2024, 12, 31),
        ctx=ctx,
        auto_download=True,
    )
    print(result.keys())


asyncio.run(main())
```

### 2) æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ç­–ç•¥

```python
from src.strategies import strategy_registry

strategies = strategy_registry.list_strategies()
print(f"Available strategies: {strategies}")
```

## ğŸ“ åˆ›å»ºæ–°ç­–ç•¥

### æ­¥éª¤1: å®šä¹‰ç­–ç•¥å‚æ•°

```python
from dataclasses import dataclass


@dataclass
class MyStrategyParams:
    lookback_period: int = 20
    threshold: float = 0.05
    position_cash_frac: float = 0.3
```

### æ­¥éª¤2: å®ç°ç­–ç•¥ç±»

```python
from typing import List
from src.strategies.base.strategy import Strategy, StrategyConfig
from src.core.types import Signal, OrderIntent, MarketData, PortfolioState, RiskState
from src.core.context import RunContext


class MyStrategy(Strategy):
    def __init__(self, params: MyStrategyParams | None = None):
        if params is None:
            params = MyStrategyParams()
        config = StrategyConfig(
            strategy_id="my_strategy",
            timeframe="1d",
            params=params.__dict__,
        )
        super().__init__(config)
        self.params = params

    def generate_signals(self, md: MarketData, ctx: RunContext) -> List[Signal]:
        signals: List[Signal] = []
        # TODO: æ ¹æ® md.bars å’Œ ctx ç”Ÿæˆä¿¡å·
        return signals

    def size_positions(
        self,
        signals: List[Signal],
        portfolio: PortfolioState,
        risk: RiskState,
        ctx: RunContext,
    ) -> List[OrderIntent]:
        intents: List[OrderIntent] = []
        # TODO: æ ¹æ®ä¿¡å·å’Œç»„åˆçŠ¶æ€ç”Ÿæˆè®¢å•æ„å›¾
        return intents


# é»˜è®¤ä¼šè‡ªåŠ¨æ³¨å†Œç­–ç•¥ï¼ˆç»§æ‰¿ Strategy å³å¯ï¼‰
```

## âœ… æœ€ä½³å®è·µ

1. **å‚æ•°é›†ä¸­**: å‚æ•°é›†ä¸­åœ¨ `StrategyConfig.params`ï¼Œä¾¿äºå›æµ‹ä¸è®°å½•
2. **æ—¥å¿—æ¸…æ™°**: åªè¾“å‡ºå…³é”®å†³ç­–ç‚¹ï¼Œé¿å…æ—¥å¿—é£æš´
3. **æœ€å°å‰¯ä½œç”¨**: ç­–ç•¥ä»…è¿”å›ä¿¡å·/æ„å›¾ï¼Œä¸ç›´æ¥ä¿®æ”¹ç»„åˆçŠ¶æ€
4. **æ•°æ®æ ¡éªŒ**: åœ¨ `generate_signals` å†…æ£€æŸ¥æ•°æ®é•¿åº¦å’Œç¼ºå¤±

## ğŸ” å‚è€ƒå®ç°

- `src/strategies/vwap/vwap_pullback_v2.py`
- `src/strategies/etf_momentum_us/strategy.py`

## ğŸ–¥ï¸ CLI å›æµ‹

å‚è€ƒï¼š`docs/ç­–ç•¥å›æµ‹CLIä½¿ç”¨æŒ‡å—.md`
