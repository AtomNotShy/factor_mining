# 因子回测系统使用说明

## 目录

1. [系统概述](#系统概述)
2. [回测功能](#回测功能)
3. [API接口使用](#api接口使用)
4. [命令行工具使用](#命令行工具使用)
5. [Web可视化界面](#web可视化界面)
6. [示例代码](#示例代码)

---

## 系统概述

本系统提供了完整的因子回测和评估功能，包括：

- **增强的回测引擎**：支持风险控制、基准对比、多因子组合
- **丰富的性能指标**：包括交易分析、风险指标等
- **可视化展示**：Web界面和命令行图表
- **API接口**：RESTful API支持程序化调用

---

## 回测功能

### 1. 基础回测

#### Python代码示例

```python
from datetime import date
from src.core.calendar import TradingCalendar
from src.core.context import RunContext, Environment
from src.evaluation.backtesting.engine import BacktestEngine
from src.strategies.etf_momentum_us.strategy import USETFMomentumStrategy

# 创建策略与回测引擎
strategy = USETFMomentumStrategy()
engine = BacktestEngine(
    initial_capital=100000.0,
    commission_rate=0.001,
    slippage_rate=0.0005,
)

# 创建运行上下文
ctx = RunContext.create(
    env=Environment.RESEARCH,
    config=strategy.config.params,
    trading_calendar=TradingCalendar(),
)

# 运行回测（自动读取本地数据，必要时补齐）
results = await engine.run(
    strategies=[strategy],
    universe=strategy.config.params["etf_pool"],
    start=date(2023, 1, 1),
    end=date(2024, 12, 31),
    ctx=ctx,
    auto_download=True,
)

# 查看结果
print(f"总收益: {results['total_return']:.2%}")
print(f"最终价值: {results['final_equity']:.2f}")
```

### 2. 带基准对比的回测

```python
# 运行带基准对比的回测
results = engine.run_backtest_with_benchmark(
    factor_values=factor_values,
    price_data=price_data,
    symbol="BTC/USDT",
    benchmark_type="buy_hold"  # 或 "market_return"
)

# 查看对比结果
print(f"策略收益: {results['strategy']['total_return']:.2%}")
print(f"基准收益: {results['benchmark']['total_return']:.2%}")
print(f"超额收益: {results['comparison']['excess_return']:.2%}")
print(f"信息比率: {results['comparison']['information_ratio']:.2f}")
print(f"Alpha: {results['comparison']['alpha']:.2%}")
print(f"Beta: {results['comparison']['beta']:.2f}")
```

### 3. 多因子组合回测

```python
# 准备多个因子
factor_dict = {
    "momentum_20": momentum_20_values,
    "momentum_60": momentum_60_values,
    "rsi": rsi_values
}

# 设置权重（可选，不设置则等权重）
weights = {
    "momentum_20": 0.5,
    "momentum_60": 0.3,
    "rsi": 0.2
}

# 运行多因子回测
results = engine.run_multi_factor_backtest(
    factor_dict=factor_dict,
    price_data=price_data,
    weights=weights,
    combination_method="weighted",  # 或 "ranked"
    symbol="BTC/USDT"
)

# 查看组合因子信息
print(f"使用的因子: {results['multi_factor_info']['factors_used']}")
print(f"组合IC: {results['multi_factor_info']['combined_ic']:.4f}")
print(f"各因子IC: {results['multi_factor_info']['individual_ics']}")
```

### 4. 风险控制参数说明

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `stop_loss` | 止损比例，当持仓亏损达到此比例时自动平仓 | 0.05 (5%) |
| `take_profit` | 止盈比例，当持仓盈利达到此比例时自动平仓 | 0.10 (10%) |
| `max_drawdown_limit` | 最大回撤限制，达到此回撤时停止回测 | 0.20 (20%) |
| `position_sizing_method` | 仓位管理方法 | "fixed" 或 "volatility" |

### 5. 分层回测

```python
# 运行分层回测
results = engine.run_quantile_backtest(
    factor_values=factor_values,
    price_data=price_data,
    quantiles=5,        # 分层数量
    long_short=True     # 是否构建多空组合
)

# 查看各层表现
for quantile, stats in results['quantile_stats'].items():
    print(f"{quantile}: 平均收益={stats['mean_return']:.4f}, "
          f"夏普={stats['sharpe_ratio']:.3f}")
```

---

## API接口使用

### 启动API服务

```bash
# 方式1：直接运行
python -m src.api.main

# 方式2：使用uvicorn
uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload
```

访问API文档：`http://localhost:8000/docs`

### 1. 单因子回测

**请求**
```bash
POST /api/v1/evaluation/backtest/factor
Content-Type: application/json

{
  "factor_name": "momentum_20",
  "symbol": "BTC/USDT",
  "days": 90,
  "initial_capital": 100000.0,
  "commission_rate": 0.001
}
```

**响应**
```json
{
  "factor_name": "momentum_20",
  "symbol": "BTC/USDT",
  "backtest_period": {
    "start_date": "2024-01-01T00:00:00",
    "end_date": "2024-04-01T00:00:00",
    "days": 90
  },
  "results": {
    "performance_stats": {
      "total_return": 0.15,
      "sharpe_ratio": 1.2,
      "max_drawdown": -0.08,
      ...
    },
    "portfolio_value": {
      "timestamps": [...],
      "values": [...]
    },
    "returns": {
      "timestamps": [...],
      "values": [...]
    }
  }
}
```

### 2. 多因子组合回测

**请求**
```bash
POST /api/v1/evaluation/backtest/multi_factor
Content-Type: application/json

{
  "factor_names": ["momentum_20", "momentum_60", "rsi"],
  "symbol": "BTC/USDT",
  "days": 90,
  "weights": {
    "momentum_20": 0.5,
    "momentum_60": 0.3,
    "rsi": 0.2
  },
  "combination_method": "weighted",
  "initial_capital": 100000.0,
  "commission_rate": 0.001
}
```

### 3. 带基准对比的回测

**请求**
```bash
POST /api/v1/evaluation/backtest/with_benchmark
Content-Type: application/json

{
  "factor_name": "momentum_20",
  "symbol": "BTC/USDT",
  "days": 90,
  "benchmark_type": "buy_hold",
  "initial_capital": 100000.0,
  "commission_rate": 0.001,
  "stop_loss": 0.05,
  "take_profit": 0.10,
  "max_drawdown_limit": 0.20
}
```

### 4. 可视化图表API

#### 净值曲线
```bash
POST /api/v1/visualization/chart/equity_curve
Content-Type: application/json

{
  "portfolio_values": {
    "timestamps": ["2024-01-01", "2024-01-02", ...],
    "values": [100000, 101000, ...]
  },
  "benchmark_values": {
    "timestamps": ["2024-01-01", "2024-01-02", ...],
    "values": [100000, 100500, ...]
  }
}
```

#### 回撤曲线
```bash
POST /api/v1/visualization/chart/drawdown
Content-Type: application/json

{
  "portfolio_values": {
    "timestamps": [...],
    "values": [...]
  }
}
```

#### 收益率分布
```bash
POST /api/v1/visualization/chart/returns_distribution
Content-Type: application/json

{
  "returns": {
    "timestamps": [...],
    "values": [...]
  }
}
```

#### 月度收益热力图
```bash
POST /api/v1/visualization/chart/monthly_returns
Content-Type: application/json

{
  "returns": {
    "timestamps": [...],
    "values": [...]
  }
}
```

### 5. Python客户端示例

```python
import requests
import json

# API基础URL
BASE_URL = "http://localhost:8000/api/v1"

# 运行回测
response = requests.post(
    f"{BASE_URL}/evaluation/backtest/factor",
    json={
        "factor_name": "momentum_20",
        "symbol": "BTC/USDT",
        "days": 90,
        "initial_capital": 100000.0
    }
)

results = response.json()

# 生成净值曲线图
chart_response = requests.post(
    f"{BASE_URL}/visualization/chart/equity_curve",
    json={
        "portfolio_values": results["results"]["portfolio_value"],
        "benchmark_values": {...}  # 可选
    }
)

chart_data = chart_response.json()
# chart_data 包含 Plotly 图表数据，可以在前端使用
```

---

## 命令行工具使用

### 策略回测 CLI（v2）

```bash
# 列出可用策略
python backtest_cli.py --list-strategies

# 使用策略 + 标的 + 天数
python backtest_cli.py --strategy us_etf_momentum --symbols SPY,QQQ,IWM --days 365

# 使用 JSON 参数
python backtest_cli.py --strategy us_etf_momentum --params '{"target_positions":2}' --start 2023-01-01 --end 2024-12-31

# 使用 key=value 参数（可重复）
python backtest_cli.py --strategy us_etf_momentum --param target_positions=2 --param rebalance_frequency=weekly
```

说明：
- `--symbols` 会覆盖策略内的 `etf_pool`
- 未指定 `--start` 时使用 `--days`
- 默认开启自动补齐数据（`--no-auto-download` 可关闭）

### 因子结果查看器

```bash
python3 factor_results_viewer.py
```

### 功能菜单

```
1. 显示汇总统计
2. 显示最佳因子
3. 按类别查看因子
4. 查看因子详情
5. 搜索因子
6. 导出结果
7. 重新加载结果
8. 生成图表          # 新增功能
9. 生成HTML报告      # 新增功能
0. 退出
```

### 使用示例

#### 1. 查看汇总统计
```
选择: 1
```

输出示例：
```
📊 因子测试汇总统计
==================================================
总因子数量: 25

📈 评级分布:
   优秀: 5 个 (20.0%)
   良好: 10 个 (40.0%)
   一般: 8 个 (32.0%)
   较差: 2 个 (8.0%)

🏆 评分统计:
   最高评分: 0.856
   最低评分: 0.234
   平均评分: 0.542
   中位数评分: 0.550
```

#### 2. 显示最佳因子
```
选择: 2
显示前几名 (默认10): 10
最低评分 (默认0.4): 0.5
```

#### 3. 生成图表
```
选择: 8
```

会在 `factor_test_results/charts/` 目录下生成以下图表：
- `score_distribution.png` - 评分分布
- `ic_distribution.png` - IC分布
- `score_vs_ic.png` - 评分vs IC散点图
- `category_comparison.png` - 类别对比

#### 4. 生成HTML报告
```
选择: 9
显示前几名 (默认20): 20
```

会生成一个包含所有统计信息和图表的HTML报告文件。

### 批量因子测试

```bash
python batch_factor_test.py
```

菜单选项：
```
1. 运行批量测试 (所有因子)
2. 运行批量测试 (按类别过滤)
3. 查看最佳因子
4. 查看因子详情
5. 加载之前的结果
0. 退出
```

---

## Web可视化界面

### 访问可视化页面

启动API服务后，访问：
```
http://localhost:8000/api/v1/visualization/
```

### 使用图表API

图表API返回Plotly JSON格式的数据，可以在前端使用Plotly.js渲染。

#### JavaScript示例

```javascript
// 获取回测结果数据
const backtestData = {
  portfolio_values: {
    timestamps: [...],
    values: [...]
  },
  returns: {
    timestamps: [...],
    values: [...]
  }
};

// 调用图表API
fetch('/api/v1/visualization/chart/equity_curve', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(backtestData)
})
.then(response => response.json())
.then(chartData => {
  // 使用Plotly渲染图表
  Plotly.newPlot('chart-container', chartData.data, chartData.layout);
});
```

---

## 示例代码

### 完整回测示例

推荐使用 v2 示例脚本：

- `examples/strategy_backtest_example.py`
- `examples/etf_momentum_backtest.py`

### 多因子组合回测示例

多因子组合回测仍在规划中，当前推荐先使用策略回测接口完成验证。

---

## 注意事项

1. **数据准备**：确保价格数据包含 `open`, `high`, `low`, `close`, `volume` 列
2. **因子注册**：使用因子前需要导入因子模块以触发注册
3. **风险控制**：合理设置止损、止盈和最大回撤限制
4. **性能考虑**：大量数据回测时注意内存使用
5. **API服务**：确保API服务正常运行后再调用接口

---

## 故障排查

### 问题1：因子不存在
**解决方案**：确保已导入因子模块
```python
import src.factors.technical  # 触发因子注册
```

### 问题2：数据不足
**解决方案**：确保有足够的历史数据，至少需要因子计算窗口+回测天数

### 问题3：API连接失败
**解决方案**：
- 检查API服务是否启动
- 检查端口是否正确
- 检查防火墙设置

### 问题4：图表生成失败
**解决方案**：
- 确保安装了matplotlib和plotly
- 检查输出目录权限
- 查看错误日志

---

## 更多信息

- API文档：`http://localhost:8000/docs`
- 项目README：查看 `README.md`
- 因子列表：运行 `python -c "from src.factors.base.factor import factor_registry; print(factor_registry.list_factors())"`

---

**版本**: 1.0  
**更新日期**: 2024年
